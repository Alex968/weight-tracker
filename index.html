<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>健康体重运营系统</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/883/883360.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    
    <style>
        :root { 
            --active-green: #32ff7e; /* 清新活力绿 */
            --data-blue: #7efff5; 
            --alert-red: #ff4d4d; 
            --bg-dark: #0a0c10; 
            --card-dark: #1a1d23;
            --border: #30363d;
        }
        
        body { 
            background: var(--bg-dark); color: #e6edf3; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
        }

        .dashboard { 
            width: 100%; max-width: 600px; height: 100%;
            background: var(--card-dark); display: flex; flex-direction: column;
            padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px;
            box-sizing: border-box;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }

        /* 顶部监测状态 */
        .header { border-left: 4px solid var(--active-green); padding-left: 15px; margin: 20px 0; flex-shrink: 0; }
        .title { margin: 0; font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px; color: #fff; }
        .monitoring-tag { 
            color: var(--active-green); font-size: 0.75rem; font-weight: bold; margin-top: 4px;
            letter-spacing: 1.5px; animation: breathe 2.5s infinite ease-in-out; 
        }
        @keyframes breathe { 0%, 100% { opacity: 1; text-shadow: 0 0 5px var(--active-green); } 50% { opacity: 0.3; text-shadow: none; } }
        
        /* 核心指标卡片 */
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; flex-shrink: 0; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 12px 5px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .stat-label { font-size: 0.65rem; color: #8b949e; margin-bottom: 5px; }
        .stat-val { font-size: 1.4rem; font-weight: 900; color: var(--data-blue); }

        /* 输入区域 */
        .input-area { background: rgba(255,255,255,0.02); padding: 15px; border-radius: 16px; margin-bottom: 20px; border: 1px solid var(--border); flex-shrink: 0; }
        .input-row { display: flex; gap: 10px; }
        input { 
            background: #0d1117; border: 1px solid var(--border); color: #fff; 
            padding: 12px; border-radius: 10px; outline: none; font-size: 1rem; min-width: 0;
            transition: border 0.3s;
        }
        input:focus { border-color: var(--active-green); }
        #dateIn { flex: 1.3; color: var(--active-green); font-size: 0.85rem; }
        #weightIn { flex: 1.5; font-weight: bold; }
        
        .pub-btn { 
            background: var(--active-green); color: #000; border: none; 
            padding: 0 20px; border-radius: 10px; cursor: pointer; font-weight: 800; 
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .pub-btn:active { transform: scale(0.95); box-shadow: 0 0 20px var(--active-green); }

        /* 图表容器 - 极致缩放适配 */
        .chart-container { 
            flex: 1.2; min-height: 200px; background: rgba(0,0,0,0.2); 
            border-radius: 16px; padding: 12px; position: relative; margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        
        /* 局部滚动表格 */
        .table-wrapper { flex: 0.8; overflow-y: auto; border-top: 1px solid var(--border); -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { position: sticky; top: 0; background: var(--card-dark); z-index: 10; padding: 12px; border-bottom: 1px solid var(--border); color: #8b949e; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #21262d; }
        .edit-input { width: 60px; background: transparent; border: none; color: #fff; text-align: center; font-size: 0.9rem; font-weight: 600; }
        .edit-input:focus { background: rgba(255,255,255,0.1); border-radius: 4px; }

        /* 底部工具栏 */
        .footer-tools { display: flex; gap: 8px; padding: 15px 0; justify-content: center; flex-shrink: 0; }
        .btn-tool { 
            border: 1px solid var(--border); color: #8b949e; font-size: 0.7rem; 
            padding: 6px 12px; border-radius: 6px; background: transparent;
        }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="header">
        <div class="title">健康体重运营系统</div>
        <div class="monitoring-tag">● MONITORING...</div>
    </div>

    <div class="stats">
        <div class="stat-box"><div class="stat-label">INITIAL</div><div class="stat-val">280</div></div>
        <div class="stat-box"><div class="stat-label">LOWEST</div><div id="curMin" class="stat-val">---</div></div>
        <div class="stat-box"><div class="stat-label">TARGET</div><div class="stat-val" style="color:var(--active-green)">180</div></div>
    </div>

    <div class="input-area">
        <div class="input-row">
            <input type="date" id="dateIn">
            <input type="number" id="weightIn" step="0.1" placeholder="体重(斤)">
            <button class="pub-btn" onclick="save()">发布</button>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <div class="table-wrapper">
        <table>
            <thead><tr><th>运营日期</th><th>最低(斤)</th><th>最高(斤)</th></tr></thead>
            <tbody id="logList"></tbody>
        </table>
    </div>

    <div class="footer-tools">
        <button class="btn-tool" onclick="chart.resetZoom()">重置视图</button>
        <button class="btn-tool" onclick="exportMarkdown()">MD复制</button>
        <button class="btn-tool" onclick="exportCSV()">导出Excel</button>
        <button class="btn-tool" style="color:var(--alert-red); border-color:#4a1515" onclick="resetAll()">格式化</button>
    </div>
</div>

<script>
    let dataMap = JSON.parse(localStorage.getItem('health_ops_final')) || {};
    let chart;

    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateIn').value = today;
        render();
    };

    function save() {
        const val = parseFloat(document.getElementById('weightIn').value);
        const dateRaw = document.getElementById('dateIn').value;
        if(!val || !dateRaw) return;
        
        const targetDate = new Date(dateRaw).toLocaleDateString('zh-CN');
        if(!dataMap[targetDate]) { 
            dataMap[targetDate] = { min: val, max: val }; 
        } else { 
            dataMap[targetDate].min = Math.min(dataMap[targetDate].min, val); 
            dataMap[targetDate].max = Math.max(dataMap[targetDate].max, val); 
        }
        
        localStorage.setItem('health_ops_final', JSON.stringify(dataMap));
        document.getElementById('weightIn').value = '';
        render();
    }

    function updateVal(date, type, val) {
        const nVal = parseFloat(val);
        if(!isNaN(nVal)) { 
            dataMap[date][type] = nVal; 
            localStorage.setItem('health_ops_final', JSON.stringify(dataMap)); 
            render(); 
        }
    }

    function render() {
        const body = document.getElementById('logList');
        const sortedDates = Object.keys(dataMap).sort((a,b) => new Date(a) - new Date(b));
        body.innerHTML = '';
        [...sortedDates].reverse().forEach(d => {
            body.innerHTML += `<tr>
                <td style="color:#8b949e">${d}</td>
                <td><input class="edit-input" type="number" step="0.1" value="${dataMap[d].min}" onchange="updateVal('${d}','min',this.value)"></td>
                <td><input class="edit-input" type="number" step="0.1" value="${dataMap[d].max}" onchange="updateVal('${d}','max',this.value)"></td>
            </tr>`;
        });
        
        if(sortedDates.length > 0) {
            // 取最后录入的一天数据的最小值作为当前最低
            document.getElementById('curMin').innerText = dataMap[sortedDates[sortedDates.length-1]].min;
        }

        const ctx = document.getElementById('myChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedDates,
                datasets: [
                    { 
                        label: 'Max', 
                        data: sortedDates.map(d => dataMap[d].max), 
                        borderColor: '#ff4d4d', 
                        borderWidth: 1, 
                        pointRadius: 1, 
                        tension: 0.4 
                    },
                    { 
                        label: 'Min', 
                        data: sortedDates.map(d => dataMap[d].min), 
                        borderColor: '#32ff7e', 
                        borderWidth: 3, 
                        fill: true, 
                        backgroundColor: 'rgba(50,255,126,0.05)', 
                        tension: 0.4,
                        pointBackgroundColor: '#32ff7e'
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    y: { 
                        suggestedMin: 175, 
                        grid: { color: 'rgba(255,255,255,0.05)' }, 
                        ticks: { color: '#484f58', font: {size: 10} } 
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#484f58', font: {size: 10} } 
                    }
                },
                plugins: { 
                    legend: { display: false }, 
                    zoom: { 
                        pan: { enabled: true, mode: 'xy' }, 
                        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' } 
                    } 
                }
            }
        });
    }

    function exportMarkdown() {
        const sortedDates = Object.keys(dataMap).sort((a,b) => new Date(a) - new Date(b));
        let md = "| 日期 | 最低 | 最高 |\n| --- | --- | --- |\n";
        sortedDates.forEach(d => md += `| ${d} | ${dataMap[d].min} | ${dataMap[d].max} |\n`);
        const el = document.createElement('textarea'); el.value = md; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
        alert("Markdown表格已存入剪贴板");
    }

    function exportCSV() {
        const sortedDates = Object.keys(dataMap).sort((a,b) => new Date(a) - new Date(b));
        let csv = "\ufeff日期,最低(斤),最高(斤)\n";
        sortedDates.forEach(d => csv += `${d},${dataMap[d].min},${dataMap[d].max}\n`);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `health_ops_data.csv`; link.click();
    }

    function resetAll() { if(confirm("警告：这将清除所有历史运营数据！确认吗？")) { dataMap = {}; localStorage.clear(); render(); } }
</script>
</body>
</html>
